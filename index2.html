<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Virtual Wardrobe - AI Enabled</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const { createElement: h, useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    // API Key - YOU MUST ADD YOUR ANTHROPIC API KEY HERE
    const ANTHROPIC_API_KEY = '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'; // Replace with your key from console.anthropic.com

    function VirtualWardrobe() {
      const [wardrobeData, setWardrobeData] = useState({ outfits: [] });
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [successMessage, setSuccessMessage] = useState(null);
      const [selectedOutfit, setSelectedOutfit] = useState(null);
      const [processingImage, setProcessingImage] = useState(false);
      const [activeFilters, setActiveFilters] = useState([]);
      const [view, setView] = useState('gallery');
      const [outfitImage, setOutfitImage] = useState(null);
      const [detectedItems, setDetectedItems] = useState([]);
      const [analyzingOutfit, setAnalyzingOutfit] = useState(false);
      const [editingItemIndex, setEditingItemIndex] = useState(null);
      const [editingDetailItem, setEditingDetailItem] = useState(null);

      useEffect(() => { loadWardrobeData(); }, []);

      const loadWardrobeData = async () => {
        setLoading(true);
        try {
          const stored = localStorage.getItem('wardrobe-data');
          if (stored) {
            const data = JSON.parse(stored);
            setWardrobeData(data.items && !data.outfits ? { outfits: [] } : data);
          } else {
            const initialData = { outfits: [] };
            localStorage.setItem('wardrobe-data', JSON.stringify(initialData));
            setWardrobeData(initialData);
          }
        } catch (err) {
          setWardrobeData({ outfits: [] });
        } finally {
          setLoading(false);
        }
      };

      const saveWardrobeData = (data) => {
        localStorage.setItem('wardrobe-data', JSON.stringify(data));
      };

      const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const analyzeOutfitWithAI = async (imageBase64, mimeType) => {
        try {
          const base64Data = imageBase64.split(',')[1];
          const apiResponse = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'x-api-key': ANTHROPIC_API_KEY,
              'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 2000,
              messages: [{
                role: 'user',
                content: [
                  { type: 'image', source: { type: 'base64', media_type: mimeType, data: base64Data } },
                  { type: 'text', text: 'Analyze this outfit image and detect ALL individual clothing items visible. Return ONLY a JSON object with this exact format (no markdown, no backticks, no preamble):\n\n{"items":[{"name":"color + general item name","type":"one of: jacket, shirt, t-shirt, sweater, hoodie, pants, jeans, shorts, skirt, dress, shoes, sneakers, boots, hat, accessory, other","color":"#hexcode","inRealWardrobe":false}]}\n\nCRITICAL RULES:\n- Only return ONE dominant color per item as a hex code\n- Be conservative with colors - only use different colors if VERY obviously different\n- Use SIMPLE, GENERAL names: "Black jacket" NOT "Black bomber jacket"\n- Just color + general type (e.g., "White shirt", "Black shoes")\n- Detect every separate clothing item' }
                ]
              }]
            })
          });
          const data = await apiResponse.json();
          const textContent = data.content.find(c => c.type === 'text')?.text || '{"items":[]}';
          const cleanedText = textContent.replace(/```json\n?|\n?```/g, '').trim();
          return JSON.parse(cleanedText).items || [];
        } catch (err) {
          console.error('AI Error:', err);
          return [{ name: 'New Item', type: 'other', color: '#808080', inRealWardrobe: false }];
        }
      };

      const handleFileSelect = async (e) => {
        const file = e.target.files[0];
        if (file) {
          setProcessingImage(true);
          try {
            const imageBase64 = await fileToBase64(file);
            setOutfitImage(imageBase64);
            setAnalyzingOutfit(true);
            const items = await analyzeOutfitWithAI(imageBase64, file.type);
            setAnalyzingOutfit(false);
            setDetectedItems(items);
            setView('add');
          } catch (err) {
            setError('Failed to process image');
            setTimeout(() => setError(null), 3000);
          } finally {
            setProcessingImage(false);
          }
        }
      };

      const updateDetectedItem = (index, field, value) => {
        const updated = [...detectedItems];
        updated[index] = { ...updated[index], [field]: value };
        setDetectedItems(updated);
      };

      const removeDetectedItem = (index) => setDetectedItems(detectedItems.filter((_, i) => i !== index));
      const generateOutfitName = () => detectedItems.map(item => item.name).join(', ');

      const addOutfit = () => {
        if (detectedItems.length === 0) { setError('No items to add'); setTimeout(() => setError(null), 3000); return; }
        const newOutfit = {
          id: Date.now().toString(),
          name: generateOutfitName(),
          items: detectedItems,
          imageUrl: outfitImage,
          dateAdded: new Date().toISOString(),
          inRealWardrobe: detectedItems.some(item => item.inRealWardrobe)
        };
        const updatedData = { outfits: [...wardrobeData.outfits, newOutfit] };
        setWardrobeData(updatedData);
        saveWardrobeData(updatedData);
        setOutfitImage(null);
        setDetectedItems([]);
        setView('gallery');
        setSuccessMessage('Outfit added');
        setTimeout(() => setSuccessMessage(null), 3000);
      };

      const updateOutfitItem = (itemIndex, field, value) => {
        const updatedItems = [...selectedOutfit.items];
        updatedItems[itemIndex] = { ...updatedItems[itemIndex], [field]: value };
        setSelectedOutfit({
          ...selectedOutfit,
          items: updatedItems,
          name: updatedItems.map(item => item.name).join(', '),
          inRealWardrobe: updatedItems.some(item => item.inRealWardrobe)
        });
      };

      const saveOutfitChanges = () => {
        const updatedData = { outfits: wardrobeData.outfits.map(outfit => outfit.id === selectedOutfit.id ? selectedOutfit : outfit) };
        setWardrobeData(updatedData);
        saveWardrobeData(updatedData);
        setEditingDetailItem(null);
        setSuccessMessage('Changes saved');
        setTimeout(() => setSuccessMessage(null), 3000);
      };

      const handleDeleteOutfit = (outfitId, e) => {
        if (e) e.stopPropagation();
        const updatedData = { outfits: wardrobeData.outfits.filter(outfit => outfit.id !== outfitId) };
        setWardrobeData(updatedData);
        setSelectedOutfit(null);
        setSuccessMessage('Outfit deleted');
        setTimeout(() => setSuccessMessage(null), 3000);
        saveWardrobeData(updatedData);
      };

      const handleExport = () => {
        const dataStr = JSON.stringify(wardrobeData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `wardrobe-backup-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        setSuccessMessage('Wardrobe exported');
        setTimeout(() => setSuccessMessage(null), 3000);
      };

      const handleImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const importedData = JSON.parse(event.target.result);
            setWardrobeData(importedData);
            saveWardrobeData(importedData);
            setSuccessMessage('Wardrobe imported');
            setTimeout(() => setSuccessMessage(null), 3000);
          } catch (err) { setError('Failed to import data'); setTimeout(() => setError(null), 3000); }
        };
        reader.readAsText(file);
      };

      const toggleFilter = (itemName, e) => {
        e.stopPropagation();
        setActiveFilters(activeFilters.includes(itemName) ? activeFilters.filter(f => f !== itemName) : [...activeFilters, itemName]);
      };

      const removeFilter = (itemName) => setActiveFilters(activeFilters.filter(f => f !== itemName));

      const getFilteredOutfits = () => {
        if (activeFilters.length === 0) return wardrobeData.outfits;
        return wardrobeData.outfits.filter(outfit => activeFilters.every(filter => outfit.items.some(item => item.name === filter)));
      };

      const filteredOutfits = getFilteredOutfits();

      if (loading) {
        return h('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center' },
          h('div', { className: 'text-center' },
            h('div', { className: 'w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4' }),
            h('p', { className: 'text-gray-600' }, 'Loading...')
          )
        );
      }

      return h('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50' },
        // Toast messages
        (successMessage || error) && h('div', { className: 'fixed bottom-8 left-1/2 transform -translate-x-1/2 z-[100]' },
          successMessage && h('div', { className: 'bg-black text-white px-6 py-3 rounded-lg shadow-2xl' }, successMessage),
          error && h('div', { className: 'bg-black text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-3' },
            h('span', null, error),
            h('button', { onClick: () => setError(null) }, '×')
          )
        ),

        // Processing overlay
        processingImage && h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50' },
          h('div', { className: 'bg-white rounded-2xl shadow-2xl p-12 text-center' },
            h('div', { className: 'w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4' }),
            h('p', { className: 'text-xl font-semibold text-gray-800 mb-2' }, 'Processing image...'),
            analyzingOutfit && h('p', { className: 'text-sm text-gray-600' }, 'AI is analyzing your outfit')
          )
        ),

        // Header
        h('header', { className: 'bg-white shadow-sm' },
          h('div', { className: 'max-w-7xl mx-auto px-4 py-4' },
            h('div', { className: 'flex items-center justify-between flex-wrap gap-3' },
              h('div', { className: 'flex items-center gap-3' },
                h('div', { className: 'w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center' },
                  h('svg', { className: 'w-6 h-6 text-white', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' },
                    h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z' })
                  )
                ),
                h('h1', { className: 'text-2xl font-bold text-gray-800' }, 'Virtual Wardrobe')
              ),
              h('div', { className: 'flex items-center gap-3' },
                h('button', { onClick: handleExport, className: 'px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50' }, 'Export'),
                h('label', { className: 'px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer' },
                  'Import',
                  h('input', { type: 'file', accept: '.json', onChange: handleImport, className: 'hidden' })
                ),
                h('label', { className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer' },
                  'Upload',
                  h('input', { type: 'file', accept: 'image/*', onChange: handleFileSelect, className: 'hidden' })
                )
              )
            )
          )
        ),

        // Main content
        h('main', { className: 'max-w-7xl mx-auto px-4 py-8' },
          wardrobeData.outfits.length === 0 ?
            h('div', { className: 'text-center py-20 bg-white rounded-2xl shadow-lg border-2 border-dashed border-gray-300' },
              h('svg', { className: 'w-20 h-20 text-gray-300 mx-auto mb-4', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' },
                h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z' })
              ),
              h('h3', { className: 'text-xl font-semibold text-gray-700 mb-2' }, 'No outfits yet'),
              h('p', { className: 'text-gray-500 mb-6' }, 'Upload an outfit image and AI will detect the items'),
              h('label', { className: 'inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer' },
                'Upload',
                h('input', { type: 'file', accept: 'image/*', onChange: handleFileSelect, className: 'hidden' })
              )
            )
          :
            h('div', null,
              h('div', { className: 'flex items-center gap-3 flex-wrap mb-6' },
                h('h2', { className: 'text-2xl font-bold text-gray-800' }, 
                  `${filteredOutfits.length} ${filteredOutfits.length === 1 ? 'outfit' : 'outfits'}${activeFilters.length > 0 ? ' with' : ''}`
                ),
                ...activeFilters.map(filter =>
                  h('div', { key: filter, className: 'flex items-center gap-2 bg-blue-100 text-blue-800 px-3 py-1.5 rounded-lg text-sm font-medium' },
                    h('span', null, filter),
                    h('button', { onClick: () => removeFilter(filter) }, '×')
                  )
                )
              ),
              h('div', { className: 'grid grid-cols-4 gap-4' },
                ...filteredOutfits.map(outfit =>
                  h('div', { 
                    key: outfit.id, 
                    className: 'bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow cursor-pointer',
                    onClick: () => setSelectedOutfit(outfit)
                  },
                    h('div', { className: 'relative aspect-[3/4] bg-gray-100 group' },
                      h('img', { src: outfit.imageUrl, alt: outfit.name, className: 'w-full h-full object-cover' }),
                      h('button', { 
                        onClick: (e) => handleDeleteOutfit(outfit.id, e),
                        className: 'absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity'
                      }, '×')
                    ),
                    h('div', { className: 'p-3', onClick: (e) => e.stopPropagation() },
                      h('div', { className: 'flex flex-wrap gap-2' },
                        ...outfit.items.map((item, idx) =>
                          h('button', {
                            key: idx,
                            onClick: (e) => toggleFilter(item.name, e),
                            className: `flex items-center gap-1.5 px-2.5 py-1 text-xs rounded-lg transition-colors ${activeFilters.includes(item.name) ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`
                          },
                            h('div', { className: 'w-3 h-3 rounded-full border border-white shadow-sm', style: { backgroundColor: item.color } }),
                            h('span', null, item.name)
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
        ),

        // Add/Edit modals would go here (simplified for brevity)
        view === 'add' && h('div', { 
          className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4',
          onClick: () => { setView('gallery'); setOutfitImage(null); setDetectedItems([]); }
        },
          h('div', { 
            className: 'bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-auto',
            onClick: (e) => e.stopPropagation()
          },
            h('div', { className: 'p-8' },
              h('h2', { className: 'text-2xl font-bold mb-6' }, 'AI Detected Items'),
              h('div', { className: 'grid grid-cols-2 gap-8' },
                h('img', { src: outfitImage, className: 'w-full rounded-lg' }),
                h('div', null,
                  h('div', { className: 'space-y-4 mb-6' },
                    ...detectedItems.map((item, i) =>
                      h('div', { key: i, className: 'border rounded-lg p-4' },
                        h('div', { className: 'flex items-center gap-3 mb-3' },
                          h('div', { className: 'w-8 h-8 rounded-full', style: { backgroundColor: item.color } }),
                          h('input', { 
                            type: 'text',
                            value: item.name,
                            onChange: (e) => updateDetectedItem(i, 'name', e.target.value),
                            className: 'flex-1 px-3 py-2 border rounded-lg'
                          }),
                          h('button', { onClick: () => removeDetectedItem(i) }, '×')
                        ),
                        h('label', { className: 'flex items-center gap-2 text-sm cursor-pointer' },
                          h('input', { 
                            type: 'checkbox',
                            checked: item.inRealWardrobe,
                            onChange: (e) => updateDetectedItem(i, 'inRealWardrobe', e.target.checked)
                          }),
                          'I own this item'
                        )
                      )
                    )
                  ),
                  h('div', { className: 'flex gap-3' },
                    h('button', { 
                      onClick: () => { setView('gallery'); setOutfitImage(null); setDetectedItems([]); },
                      className: 'flex-1 px-6 py-3 border rounded-lg'
                    }, 'Cancel'),
                    h('button', { 
                      onClick: addOutfit,
                      className: 'flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold'
                    }, 'Add Outfit')
                  )
                )
              )
            )
          )
        ),

        // Detail modal (simplified)
        selectedOutfit && h('div', { 
          className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4',
          onClick: () => { setSelectedOutfit(null); setEditingDetailItem(null); }
        },
          h('div', { 
            className: 'bg-white rounded-2xl shadow-2xl max-w-6xl w-full overflow-auto',
            onClick: (e) => e.stopPropagation()
          },
            h('div', { className: 'grid grid-cols-2' },
              h('div', { className: 'p-8' },
                h('img', { src: selectedOutfit.imageUrl, className: 'w-full rounded-lg' })
              ),
              h('div', { className: 'p-8' },
                h('h2', { className: 'text-2xl font-bold mb-6' }, selectedOutfit.name),
                h('div', { className: 'space-y-4 mb-8' },
                  ...selectedOutfit.items.map((item, i) =>
                    h('div', { key: i, className: 'border rounded-lg p-4' },
                      h('div', { className: 'flex items-center gap-3' },
                        h('div', { className: 'w-8 h-8 rounded-full', style: { backgroundColor: item.color } }),
                        h('span', { className: 'font-semibold' }, item.name),
                        item.inRealWardrobe && h('span', { className: 'ml-auto bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs' }, 'Owned')
                      )
                    )
                  )
                ),
                h('button', { 
                  onClick: () => handleDeleteOutfit(selectedOutfit.id),
                  className: 'w-full px-6 py-3 bg-red-600 text-white rounded-lg font-semibold'
                }, 'Delete Outfit')
              )
            )
          )
        )
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(h(VirtualWardrobe));
  </script>
</body>
</html>
